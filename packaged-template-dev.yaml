AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: An app (read/write to DynamoDB) with a RESTful API endpoint using Amazon
  API Gateway.
Parameters:
  Stage:
    Type: String
Globals:
  Api:
    OpenApiVersion: 3.0.3
  Function:
    Runtime: python3.8
    MemorySize: 512
    Timeout: 3
    Environment:
      Variables:
        TABLE_NAME:
          Ref: DynamoDBTable
Resources:
  RestApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: RestApi
      Description: An API for serverless app
      StageName:
        Ref: Stage
      DefinitionBody:
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: s3://announcement-app/artifacts/dev/1c6598cd042ea259c64a04486075ad65
  AddAnnouncement:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: AddAnnouncement
      Handler: lambda_add_item.add_announcement
      Description: Write to DynamoDB through a RESTful API endpoint using Amazon API
        Gateway.
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DynamoDBTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /announcements/add
            Method: post
            RestApiId:
              Ref: RestApi
            Auth:
              Authorizer: AWS_IAM
              ResourcePolicy:
                CustomStatements:
                - Effect: Allow
                  Principal:
                    AWS:
                    - arn:aws:iam::234723943124:user/lambda-user
                  Action: execute-api:Invoke
                  Resource:
                    Fn::Sub: execute-api:/${Stage}/POST/announcements/add
      CodeUri: s3://announcement-app/artifacts/dev/c6f3113be2534dd04b7858a6c39fa586
  GetAllAnnouncements:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: GetAllAnnouncements
      Handler: lambda_get_all_items.list_announcements
      Description: Read from DynamoDB through a RESTful API endpoint using Amazon
        API Gateway.
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DynamoDBTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /announcements
            Method: get
            RestApiId:
              Ref: RestApi
      CodeUri: s3://announcement-app/artifacts/dev/c6f3113be2534dd04b7858a6c39fa586
  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
      - AttributeName: title
        AttributeType: S
      - AttributeName: date-time
        AttributeType: S
      KeySchema:
      - AttributeName: title
        KeyType: HASH
      - AttributeName: date-time
        KeyType: RANGE
      TableName: announcements
      BillingMode: PAY_PER_REQUEST
