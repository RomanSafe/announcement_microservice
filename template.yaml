AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'
Description: An app (read/write to DynamoDB) with a RESTful API endpoint using Amazon API Gateway.
Parameters:
  Stage:
    Type: String

Globals:
  #https://github.com/awslabs/serverless-application-model/blob/develop/docs/globals.rst
  Api:
    OpenApiVersion: 3.0.3
  Function:
    Runtime: python3.8
    MemorySize: 512
    Timeout: 3
    Environment:
      Variables:
        TABLE_NAME:
          Ref: DynamoDBTable

Resources:
  RestApi:
    Type: 'AWS::Serverless::Api'
    Properties:
      Name: RestApi
      Description: An API for serverless app
      StageName:
        Ref: Stage
      DefinitionBody:
        'Fn::Transform':
          Name: 'AWS::Include'
          Parameters:
            Location: ./openapi.yaml
  AddAnnouncement:
    Type: 'AWS::Serverless::Function'
    Properties:
      FunctionName: AddAnnouncement
      Handler: lambda_add_item.add_announcement
      Description: Write to DynamoDB through a RESTful API endpoint using Amazon API Gateway.
      Policies:
        - DynamoDBCrudPolicy:
            TableName:
              Ref: DynamoDBTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /add-announcement
            Method: post
            RestApiId:
              Ref: RestApi
      CodeUri: ./code

  GetAllAnnouncements:
    Type: 'AWS::Serverless::Function'
    Properties:
      FunctionName: GetAllAnnouncements
      Handler: lambda_get_all_items.list_announcements
      Description: Read from DynamoDB through a RESTful API endpoint using Amazon API Gateway.
      Policies:
        - DynamoDBCrudPolicy:
            TableName:
              Ref: DynamoDBTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /list-announcements
            Method: get
            RestApiId:
              Ref: RestApi
      CodeUri: ./code

  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: Title
          AttributeType: S
        - AttributeName: Date-time
          AttributeType: S
      KeySchema:
        - AttributeName: Title
          KeyType: HASH
        - AttributeName: Date-time
          KeyType: RANGE
      TableName: announcements
      BillingMode: PAY_PER_REQUEST
